<?xml version="1.0" encoding="utf-8"?>
<!-- build/RpaWinUiComponents.targets - MINIMÁLNA MSB3030 OPRAVA -->
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <RpaWinUiComponentsVersion Condition="'$(RpaWinUiComponentsVersion)' == ''">1.0.14</RpaWinUiComponentsVersion>
  </PropertyGroup>

  <!-- ✅ ZÁKLADNÁ KONTROLA: Nie sme v samom RpaWinUiComponents projekte -->
  <PropertyGroup>
    <_IsRpaWinUiComponentsProject Condition="'$(AssemblyName)' == 'RpaWinUiComponents' OR '$(MSBuildProjectName)' == 'RpaWinUiComponents'">true</_IsRpaWinUiComponentsProject>
    <_IsRpaWinUiComponentsProject Condition="'$(_IsRpaWinUiComponentsProject)' == ''">false</_IsRpaWinUiComponentsProject>
  </PropertyGroup>

  <!-- ✅ ROZŠÍRENÁ OPRAVA: Suppress všetky XBF related warnings/errors -->
  <PropertyGroup>
    <!-- Suppress MSB3030 (file not found) pre XBF súbory -->
    <MSBuildWarningsAsMessages>$(MSBuildWarningsAsMessages);MSB3030</MSBuildWarningsAsMessages>
    <NoWarn>$(NoWarn);MSB3030;MSB3277;MSB3026;MSB3061</NoWarn>

    <!-- Dodatočné MSBuild nastavenia pre XBF potlačenie -->
    <ErrorOnDuplicateItems>false</ErrorOnDuplicateItems>
    <TreatWarningsAsErrors>false</TreatWarningsAsErrors>
  </PropertyGroup>

  <!-- ✅ KĽÚČOVÁ OPRAVA MSB3030: Úplne potlač XBF operácie -->
  <Target Name="ExcludeXbfFiles" BeforeTargets="ResolveAssemblyReferences;CopyFilesToOutputDirectory;GetCopyToOutputDirectoryItems;GetTargetPath" Condition="'$(_IsRpaWinUiComponentsProject)' == 'false'">
    <ItemGroup>
      <!-- Odstráň všetky XBF súbory zo všetkých možných lokácií -->
      <ContentWithTargetPath Remove="**/*.xbf" />
      <ReferenceCopyLocalPaths Remove="**/*.xbf" />
      <FilesToCopy Remove="**/*.xbf" />
      <Content Remove="**/*.xbf" />
      <None Remove="**/*.xbf" />
      <EmbeddedResource Remove="**/*.xbf" />
      <Resource Remove="**/*.xbf" />

      <!-- Špecificky pre RpaWinUiComponents -->
      <ReferenceCopyLocalPaths Remove="**\RpaWinUiComponents\**\*.xbf" />
      <ContentWithTargetPath Remove="**\RpaWinUiComponents\**\*.xbf" />
      <FilesToCopy Remove="**\RpaWinUiComponents\**\*.xbf" />

      <!-- Odstráň z package assets -->
      <_ResolvedCopyLocalBuildProjectReferences Remove="**\*.xbf" />
      <RuntimeCopyLocalItems Remove="**\*.xbf" />
    </ItemGroup>

    <Message Text="🚫 RpaWinUiComponents: Všetky XBF operácie potlačené (MSB3030 fix)" Importance="low" />
  </Target>

  <!-- ✅ DODATOČNÁ OCHRANA: Potlač XBF z package resolving -->
  <Target Name="RemoveXbfFromPackages" AfterTargets="ResolvePackageAssets" BeforeTargets="ResolveAssemblyReferences">
    <ItemGroup>
      <ReferenceCopyLocalPaths Remove="@(ReferenceCopyLocalPaths)" Condition="'%(ReferenceCopyLocalPaths.Extension)' == '.xbf'" />
      <RuntimeCopyLocalItems Remove="@(RuntimeCopyLocalItems)" Condition="'%(RuntimeCopyLocalItems.Extension)' == '.xbf'" />
      <ContentWithTargetPath Remove="@(ContentWithTargetPath)" Condition="'%(ContentWithTargetPath.Extension)' == '.xbf'" />
    </ItemGroup>
  </Target>

  <!-- ✅ ZACHOVANÉ: WinUI dependencies -->
  <ItemGroup Condition="'$(UseWinUI)' == 'true'">
    <PackageReference Include="Microsoft.WindowsAppSDK" Version="1.7.250606001" Condition="'@(PackageReference->WithMetadataValue('Identity', 'Microsoft.WindowsAppSDK'))' == ''" />
    <PackageReference Include="Microsoft.Extensions.DependencyInjection" Version="9.0.6" Condition="'@(PackageReference->WithMetadataValue('Identity', 'Microsoft.Extensions.DependencyInjection'))' == ''" />
    <PackageReference Include="Microsoft.Extensions.Hosting" Version="9.0.6" Condition="'@(PackageReference->WithMetadataValue('Identity', 'Microsoft.Extensions.Hosting'))' == ''" />
    <PackageReference Include="Microsoft.Extensions.Logging.Abstractions" Version="9.0.6" Condition="'@(PackageReference->WithMetadataValue('Identity', 'Microsoft.Extensions.Logging.Abstractions'))' == ''" />
  </ItemGroup>

  <!-- ✅ ZACHOVANÉ: Info message -->
  <Target Name="RpaWinUiComponentsInfo" BeforeTargets="Build" Condition="'$(_IsRpaWinUiComponentsProject)' == 'false'">
    <Message Text="📦 RpaWinUiComponents v$(RpaWinUiComponentsVersion) (MSB3030 XBF fix applied)" Importance="normal" />
  </Target>

</Project>