<?xml version="1.0" encoding="utf-8"?>
<!-- build/RpaWinUiComponents.targets - OPRAVA CIEST K DLL a SUPRESSIA WARNINGS -->
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <RpaWinUiComponentsVersion Condition="'$(RpaWinUiComponentsVersion)' == ''">1.0.8</RpaWinUiComponentsVersion>
  </PropertyGroup>

  <!-- ✅ OPRAVENÉ: Detect target framework and set paths accordingly -->
  <PropertyGroup>
    <_RpaWinUiTargetFramework Condition="'$(TargetFramework)' != ''">$(TargetFramework)</_RpaWinUiTargetFramework>
    <_RpaWinUiTargetFramework Condition="'$(_RpaWinUiTargetFramework)' == '' AND '$(TargetFrameworkMoniker)' != ''">$(TargetFrameworkMoniker.Substring($(TargetFrameworkMoniker.LastIndexOf('='))').Replace('=',''))</_RpaWinUiTargetFramework>
    <_RpaWinUiTargetFramework Condition="'$(_RpaWinUiTargetFramework)' == ''">net8.0-windows10.0.19041.0</_RpaWinUiTargetFramework>
  </PropertyGroup>

  <!-- ✅ KRITICKÁ OPRAVA: Kontrola či nie sme v projekte RpaWinUiComponents samom -->
  <PropertyGroup>
    <_IsRpaWinUiComponentsProject Condition="'$(AssemblyName)' == 'RpaWinUiComponents' OR '$(MSBuildProjectName)' == 'RpaWinUiComponents'">true</_IsRpaWinUiComponentsProject>
    <_IsRpaWinUiComponentsProject Condition="'$(_IsRpaWinUiComponentsProject)' == ''">false</_IsRpaWinUiComponentsProject>
  </PropertyGroup>

  <!-- ✅ KRITICKÁ OPRAVA: Správne cesty k DLL súboru -->
  <PropertyGroup>
    <!-- Hlavná cesta - presne podľa štruktúry NuGet package -->
    <_RpaWinUiComponentsLibPath>$(MSBuildThisFileDirectory)../lib/$(_RpaWinUiTargetFramework)/RpaWinUiComponents.dll</_RpaWinUiComponentsLibPath>

    <!-- Fallback cesty pre rôzne framework verzie -->
    <_RpaWinUiComponentsLibPathFallback1>$(MSBuildThisFileDirectory)../lib/net8.0-windows10.0.19041.0/RpaWinUiComponents.dll</_RpaWinUiComponentsLibPathFallback1>
    <_RpaWinUiComponentsLibPathFallback2>$(MSBuildThisFileDirectory)../lib/net8.0-windows/RpaWinUiComponents.dll</_RpaWinUiComponentsLibPathFallback2>
    <_RpaWinUiComponentsLibPathFallback3>$(MSBuildThisFileDirectory)../lib/net8.0/RpaWinUiComponents.dll</_RpaWinUiComponentsLibPathFallback3>
  </PropertyGroup>

  <!-- ✅ Ensure WinUI 3 dependencies for consuming projects -->
  <ItemGroup Condition="'$(UseWinUI)' == 'true' OR '$(TargetFramework)' == 'net8.0-windows10.0.19041.0'">
    <PackageReference Include="Microsoft.WindowsAppSDK" Version="1.7.250606001" Condition="'@(PackageReference->WithMetadataValue('Identity', 'Microsoft.WindowsAppSDK'))' == ''" />
    <PackageReference Include="Microsoft.Extensions.DependencyInjection" Version="9.0.6" Condition="'@(PackageReference->WithMetadataValue('Identity', 'Microsoft.Extensions.DependencyInjection'))' == ''" />
    <PackageReference Include="Microsoft.Extensions.Hosting" Version="9.0.6" Condition="'@(PackageReference->WithMetadataValue('Identity', 'Microsoft.Extensions.Hosting'))' == ''" />
    <PackageReference Include="Microsoft.Extensions.Logging.Abstractions" Version="9.0.6" Condition="'@(PackageReference->WithMetadataValue('Identity', 'Microsoft.Extensions.Logging.Abstractions'))' == ''" />
  </ItemGroup>

  <!-- ✅ Force UseWinUI if not set and we're targeting Windows -->
  <PropertyGroup Condition="'$(UseWinUI)' == '' AND ('$(TargetFramework)' == 'net8.0-windows10.0.19041.0' OR $(TargetFramework.Contains('windows')))">
    <UseWinUI>true</UseWinUI>
  </PropertyGroup>

  <!-- ✅ OPRAVENÉ: Add main assembly reference s lepším fallback mechanizmom - ALE LEN AK NIE SME V SAMOM PROJEKTE -->
  <Target Name="AddRpaWinUiComponentsReference" BeforeTargets="ResolveAssemblyReferences" Condition="'$(_IsRpaWinUiComponentsProject)' == 'false'">
    <!-- Nájdi existujúcu DLL -->
    <PropertyGroup>
      <_LibraryPath Condition="Exists('$(_RpaWinUiComponentsLibPath)')">$(_RpaWinUiComponentsLibPath)</_LibraryPath>
      <_LibraryPath Condition="'$(_LibraryPath)' == '' AND Exists('$(_RpaWinUiComponentsLibPathFallback1)')">$(_RpaWinUiComponentsLibPathFallback1)</_LibraryPath>
      <_LibraryPath Condition="'$(_LibraryPath)' == '' AND Exists('$(_RpaWinUiComponentsLibPathFallback2)')">$(_RpaWinUiComponentsLibPathFallback2)</_LibraryPath>
      <_LibraryPath Condition="'$(_LibraryPath)' == '' AND Exists('$(_RpaWinUiComponentsLibPathFallback3)')">$(_RpaWinUiComponentsLibPathFallback3)</_LibraryPath>
    </PropertyGroup>

    <!-- Pridaj reference ak sa našla DLL -->
    <ItemGroup Condition="'$(_LibraryPath)' != ''">
      <Reference Include="RpaWinUiComponents">
        <HintPath>$(_LibraryPath)</HintPath>
        <Private>False</Private>
        <SpecificVersion>False</SpecificVersion>
      </Reference>
    </ItemGroup>

    <!-- OPRAVA: Informačné výstupy LEN AK SA PODARILO ALEBO ZLYHALO -->
    <Message Text="✅ RpaWinUiComponents: Added reference to $(_LibraryPath)" Importance="low" Condition="'$(_LibraryPath)' != ''" />

    <!-- OPRAVA: Error messages LEN ak je to skutočne problém - a nie počas vývoja -->
    <Warning Text="⚠️ RpaWinUiComponents: Library not found in NuGet package. This is normal during development." Condition="'$(_LibraryPath)' == '' AND '$(Configuration)' != 'Debug'" />
  </Target>

  <!-- ✅ OPRAVENÉ: Info message - LEN AK NIE SME V SAMOM PROJEKTE -->
  <Target Name="RpaWinUiComponentsInfo" BeforeTargets="Build" Condition="'$(_IsRpaWinUiComponentsProject)' == 'false'">
    <Message Text="📦 RpaWinUiComponents v$(RpaWinUiComponentsVersion) loaded for $(_RpaWinUiTargetFramework)" Importance="low" />
    <Message Text="🔧 UseWinUI: $(UseWinUI), TargetFramework: $(TargetFramework)" Importance="low" />
  </Target>

  <!-- ✅ Ensure proper configuration for WinUI projects -->
  <Target Name="ConfigureWinUIProperties" BeforeTargets="PrepareForBuild" Condition="'$(UseWinUI)' == 'true'">
    <PropertyGroup>
      <!-- Set default values if not already set -->
      <WindowsPackageType Condition="'$(WindowsPackageType)' == ''">None</WindowsPackageType>
      <WindowsAppSDKSelfContained Condition="'$(WindowsAppSDKSelfContained)' == ''">false</WindowsAppSDKSelfContained>
      <EnableMsixTooling Condition="'$(EnableMsixTooling)' == ''">false</EnableMsixTooling>
    </PropertyGroup>
  </Target>

  <!-- ✅ Suppress common warnings in consuming projects -->
  <PropertyGroup>
    <NoWarn>$(NoWarn);CS0436;CS1061;CS1537;CS1503;CS0104;WMC1013</NoWarn>
  </PropertyGroup>

</Project>