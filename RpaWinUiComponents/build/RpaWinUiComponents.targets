<?xml version="1.0" encoding="utf-8"?>
<!-- build/RpaWinUiComponents.targets - OPRAVENÉ XBF handling v1.0.29 -->
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <RpaWinUiComponentsVersion Condition="'$(RpaWinUiComponentsVersion)' == ''">1.0.29</RpaWinUiComponentsVersion>
  </PropertyGroup>

  <!-- ✅ ZÁKLADNÁ KONTROLA: Nie sme v samom RpaWinUiComponents projekte -->
  <PropertyGroup>
    <_IsRpaWinUiComponentsProject Condition="'$(AssemblyName)' == 'RpaWinUiComponents' OR '$(MSBuildProjectName)' == 'RpaWinUiComponents'">true</_IsRpaWinUiComponentsProject>
    <_IsRpaWinUiComponentsProject Condition="'$(_IsRpaWinUiComponentsProject)' == ''">false</_IsRpaWinUiComponentsProject>
  </PropertyGroup>

  <!-- ✅ OPRAVENÉ NASTAVENIA pre consuming projects - BEZ problematických flags -->
  <PropertyGroup Condition="'$(_IsRpaWinUiComponentsProject)' == 'false'">
    <!-- Zabezpečenie WinUI 3 nastavení -->
    <UseWinUI Condition="'$(UseWinUI)' == ''">true</UseWinUI>

    <!-- ✅ OPRAVENÉ XBF nastavenia - BEZ problematických CodeGenerationControlFlags -->
    <GenerateXbf Condition="'$(GenerateXbf)' == ''">true</GenerateXbf>
    <EnableXbfGeneration Condition="'$(EnableXbfGeneration)' == ''">true</EnableXbfGeneration>
    <UseWinUIModernResourceSystem Condition="'$(UseWinUIModernResourceSystem)' == ''">true</UseWinUIModernResourceSystem>

    <!-- ✅ RIEŠENIE XLS0414: Framework references -->
    <DisableImplicitFrameworkReferences Condition="'$(DisableImplicitFrameworkReferences)' == ''">false</DisableImplicitFrameworkReferences>
    <ImplicitlyExpandNETStandardFacades Condition="'$(ImplicitlyExpandNETStandardFacades)' == ''">true</ImplicitlyExpandNETStandardFacades>

    <!-- Základné warning suppression -->
    <NoWarn>$(NoWarn);CS0436;WMC1013;CA1416;WMC1003;XLS0414</NoWarn>

    <!-- MSBuild nastavenia -->
    <ErrorOnDuplicateItems>false</ErrorOnDuplicateItems>
    <TreatWarningsAsErrors>false</TreatWarningsAsErrors>

    <!-- ✅ OPRAVA: Problematické chyby ako warnings -->
    <MSBuildWarningsAsMessages>$(MSBuildWarningsAsMessages);MSB3030;WMC1003;XLS0414</MSBuildWarningsAsMessages>
    <MSBuildTreatWarningsAsErrors>false</MSBuildTreatWarningsAsErrors>
    <WarningsNotAsErrors>WMC1003;XLS0414</WarningsNotAsErrors>
  </PropertyGroup>

  <!-- ✅ OPRAVENÉ: Enhanced kopírovanie XBF súborov z NuGet package -->
  <Target Name="CopyRpaComponentsXbfFiles" BeforeTargets="Build" Condition="'$(_IsRpaWinUiComponentsProject)' == 'false'">

    <Message Text="📦 RpaWinUiComponents v$(RpaWinUiComponentsVersion): Enhanced XBF copying from NuGet package..." Importance="normal" />

    <!-- ✅ Nájdi XBF súbory v NuGet package -->
    <ItemGroup>
      <RpaXbfFiles Include="@(ReferenceCopyLocalPaths)" Condition="$([System.String]::Copy('%(Identity)').Contains('RpaWinUiComponents')) AND $([System.String]::Copy('%(Identity)').EndsWith('.xbf'))" />
      <RpaXamlFiles Include="@(ReferenceCopyLocalPaths)" Condition="$([System.String]::Copy('%(Identity)').Contains('RpaWinUiComponents')) AND $([System.String]::Copy('%(Identity)').EndsWith('.xaml'))" />
      <RpaDllFiles Include="@(ReferenceCopyLocalPaths)" Condition="$([System.String]::Copy('%(Identity)').Contains('RpaWinUiComponents')) AND $([System.String]::Copy('%(Identity)').EndsWith('.dll'))" />
    </ItemGroup>

    <Message Text="✅ Found RpaWinUiComponents XBF files: @(RpaXbfFiles)" Importance="normal" Condition="'@(RpaXbfFiles)' != ''" />
    <Message Text="✅ Found RpaWinUiComponents XAML files: @(RpaXamlFiles)" Importance="normal" Condition="'@(RpaXamlFiles)' != ''" />
    <Message Text="✅ Found RpaWinUiComponents DLL files: @(RpaDllFiles)" Importance="normal" Condition="'@(RpaDllFiles)' != ''" />
    <Message Text="⚠️ No XBF files found in RpaWinUiComponents package - will use XAML compilation" Importance="normal" Condition="'@(RpaXbfFiles)' == ''" />

    <!-- ✅ Enhanced: Zabezpeč že XBF súbory sa skopírujú do output directory -->
    <ItemGroup Condition="'@(RpaXbfFiles)' != ''">
      <ContentWithTargetPath Include="@(RpaXbfFiles)">
        <TargetPath>%(RecursiveDir)%(Filename)%(Extension)</TargetPath>
        <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
        <CopyToPublishDirectory>PreserveNewest</CopyToPublishDirectory>
      </ContentWithTargetPath>
    </ItemGroup>

    <!-- ✅ Enhanced: Zabezpeč že XAML súbory sa skopírujú do output directory -->
    <ItemGroup Condition="'@(RpaXamlFiles)' != ''">
      <ContentWithTargetPath Include="@(RpaXamlFiles)">
        <TargetPath>%(RecursiveDir)%(Filename)%(Extension)</TargetPath>
        <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
        <CopyToPublishDirectory>PreserveNewest</CopyToPublishDirectory>
      </ContentWithTargetPath>
    </ItemGroup>

  </Target>

  <!-- ✅ NOVÉ: Ensure proper system references for consuming projects -->
  <Target Name="EnsureSystemReferencesForXLS0414" BeforeTargets="ResolveAssemblyReferences" Condition="'$(_IsRpaWinUiComponentsProject)' == 'false'">
    <Message Text="🔧 Ensuring system references for XLS0414 fix..." Importance="low" />

    <!-- Add framework references if missing -->
    <ItemGroup Condition="'@(FrameworkReference->WithMetadataValue('Identity', 'Microsoft.NETCore.App'))' == ''">
      <FrameworkReference Include="Microsoft.NETCore.App" />
    </ItemGroup>

    <ItemGroup Condition="'@(FrameworkReference->WithMetadataValue('Identity', 'Microsoft.WindowsDesktop.App'))' == ''">
      <FrameworkReference Include="Microsoft.WindowsDesktop.App" />
    </ItemGroup>

    <!-- Add system references for XLS0414 fix -->
    <ItemGroup>
      <Reference Include="System.Runtime" Pack="false" Condition="'@(Reference->WithMetadataValue('Identity', 'System.Runtime'))' == ''" />
      <Reference Include="System.ObjectModel" Pack="false" Condition="'@(Reference->WithMetadataValue('Identity', 'System.ObjectModel'))' == ''" />
      <Reference Include="System.Collections" Pack="false" Condition="'@(Reference->WithMetadataValue('Identity', 'System.Collections'))' == ''" />
    </ItemGroup>

    <Message Text="✅ System references verified for XLS0414 compatibility" Importance="low" />
  </Target>

  <!-- ✅ Info message -->
  <Target Name="RpaWinUiComponentsInfo" BeforeTargets="Build" Condition="'$(_IsRpaWinUiComponentsProject)' == 'false'">
    <Message Text="📦 RpaWinUiComponents v$(RpaWinUiComponentsVersion) (WMC1003 &amp; XLS0414 fixed)" Importance="normal" />
  </Target>

  <!-- ✅ ZACHOVANÉ: WinUI dependencies with enhanced version checking -->
  <ItemGroup Condition="'$(UseWinUI)' == 'true' AND '$(_IsRpaWinUiComponentsProject)' == 'false'">
    <PackageReference Include="Microsoft.WindowsAppSDK" Version="1.7.250606001" Condition="'@(PackageReference->WithMetadataValue('Identity', 'Microsoft.WindowsAppSDK'))' == ''" />
    <PackageReference Include="Microsoft.Extensions.DependencyInjection" Version="9.0.6" Condition="'@(PackageReference->WithMetadataValue('Identity', 'Microsoft.Extensions.DependencyInjection'))' == ''" />
    <PackageReference Include="Microsoft.Extensions.Hosting" Version="9.0.6" Condition="'@(PackageReference->WithMetadataValue('Identity', 'Microsoft.Extensions.Hosting'))' == ''" />
    <PackageReference Include="Microsoft.Extensions.Logging.Abstractions" Version="9.0.6" Condition="'@(PackageReference->WithMetadataValue('Identity', 'Microsoft.Extensions.Logging.Abstractions'))' == ''" />
  </ItemGroup>

  <!-- ✅ ENHANCED CLEANUP: Odstránenie duplicitných XBF references a error handling -->
  <Target Name="CleanupDuplicateReferences" AfterTargets="ResolveAssemblyReferences" Condition="'$(_IsRpaWinUiComponentsProject)' == 'false'">
    <ItemGroup>
      <DuplicateRpaFiles Include="@(ReferenceCopyLocalPaths)" Condition="$([System.String]::Copy('%(ReferenceCopyLocalPaths.Identity)').Contains('RpaWinUiComponents'))" />
    </ItemGroup>

    <RemoveDuplicates Inputs="@(DuplicateRpaFiles)" ContinueOnError="true">
      <Output TaskParameter="Filtered" ItemName="UniqueRpaFiles" />
    </RemoveDuplicates>

    <ItemGroup Condition="'@(UniqueRpaFiles)' != ''">
      <ReferenceCopyLocalPaths Remove="@(DuplicateRpaFiles)" />
      <ReferenceCopyLocalPaths Include="@(UniqueRpaFiles)" />
    </ItemGroup>

    <Message Text="🧹 Cleaned up duplicate RpaWinUiComponents references" Importance="normal" />
  </Target>

  <!-- ✅ ENHANCED DIAGNOSTIKA: Pre debugging XBF a XAML problémov -->
  <Target Name="DiagnoseRpaComponentsIssues" AfterTargets="ResolvePackageAssets" Condition="'$(_IsRpaWinUiComponentsProject)' == 'false' AND '$(RpaWinUiComponentsDiagnostics)' == 'true'">
    <Message Text="🔍 Enhanced RpaWinUiComponents Diagnostics v$(RpaWinUiComponentsVersion)..." Importance="high" />

    <ItemGroup>
      <RpaXamlFiles Include="@(ReferenceCopyLocalPaths)" Condition="$([System.String]::Copy('%(Identity)').Contains('RpaWinUiComponents')) AND $([System.String]::Copy('%(Identity)').EndsWith('.xaml'))" />
      <RpaXbfFiles Include="@(ReferenceCopyLocalPaths)" Condition="$([System.String]::Copy('%(Identity)').Contains('RpaWinUiComponents')) AND $([System.String]::Copy('%(Identity)').EndsWith('.xbf'))" />
      <RpaDllFiles Include="@(ReferenceCopyLocalPaths)" Condition="$([System.String]::Copy('%(Identity)').Contains('RpaWinUiComponents')) AND $([System.String]::Copy('%(Identity)').EndsWith('.dll'))" />
      <RpaAllFiles Include="@(ReferenceCopyLocalPaths)" Condition="$([System.String]::Copy('%(Identity)').Contains('RpaWinUiComponents'))" />
    </ItemGroup>

    <Message Text="🔍 RpaWinUiComponents XAML súbory: @(RpaXamlFiles)" Importance="high" />
    <Message Text="🔍 RpaWinUiComponents XBF súbory: @(RpaXbfFiles)" Importance="high" />
    <Message Text="🔍 RpaWinUiComponents DLL súbory: @(RpaDllFiles)" Importance="high" />
    <Message Text="🔍 RpaWinUiComponents všetky súbory: @(RpaAllFiles)" Importance="high" />

    <!-- Diagnostic properties -->
    <Message Text="🔧 UseWinUI: $(UseWinUI)" Importance="high" />
    <Message Text="🔧 GenerateXbf: $(GenerateXbf)" Importance="high" />
    <Message Text="🔧 EnableXbfGeneration: $(EnableXbfGeneration)" Importance="high" />
    <Message Text="🔧 TargetFramework: $(TargetFramework)" Importance="high" />
    <Message Text="🔧 WindowsAppSDK: @(PackageReference->WithMetadataValue('Identity', 'Microsoft.WindowsAppSDK')->'%(Version)')" Importance="high" />

    <!-- Framework references check -->
    <ItemGroup>
      <AllFrameworkRefs Include="@(FrameworkReference)" />
    </ItemGroup>
    <Message Text="🔧 Framework references: @(AllFrameworkRefs)" Importance="high" />
  </Target>

  <!-- ✅ NOVÉ: Backup XAML compilation for consuming projects -->
  <Target Name="EnsureXamlCompilationFallback" BeforeTargets="XamlPreCompile" Condition="'$(_IsRpaWinUiComponentsProject)' == 'false' AND '$(UseWinUI)' == 'true'">
    <Message Text="🔄 Ensuring XAML compilation fallback for RpaWinUiComponents..." Importance="low" />

    <!-- Check if XBF files are available -->
    <ItemGroup>
      <AvailableRpaXbfFiles Include="@(ReferenceCopyLocalPaths)" Condition="$([System.String]::Copy('%(Identity)').Contains('RpaWinUiComponents')) AND $([System.String]::Copy('%(Identity)').EndsWith('.xbf'))" />
    </ItemGroup>

    <PropertyGroup>
      <_RpaHasXbfFiles Condition="'@(AvailableRpaXbfFiles)' != ''">true</_RpaHasXbfFiles>
      <_RpaHasXbfFiles Condition="'@(AvailableRpaXbfFiles)' == ''">false</_RpaHasXbfFiles>
    </PropertyGroup>

    <Message Text="✅ RpaWinUiComponents XBF files available: $(_RpaHasXbfFiles)" Importance="low" />

    <!-- If no XBF files, ensure XAML compilation settings are correct -->
    <PropertyGroup Condition="'$(_RpaHasXbfFiles)' == 'false'">
      <GenerateXbf>true</GenerateXbf>
      <EnableXbfGeneration>true</EnableXbfGeneration>
    </PropertyGroup>

    <Message Text="🔄 XAML compilation fallback configured" Importance="low" Condition="'$(_RpaHasXbfFiles)' == 'false'" />
  </Target>

</Project>