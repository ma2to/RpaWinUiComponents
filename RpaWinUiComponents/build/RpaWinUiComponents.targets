<?xml version="1.0" encoding="utf-8"?>
<!-- build/RpaWinUiComponents.targets - OPRAVENÃ‰ XBF handling v1.0.24 -->
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <RpaWinUiComponentsVersion Condition="'$(RpaWinUiComponentsVersion)' == ''">1.0.24</RpaWinUiComponentsVersion>
  </PropertyGroup>

  <!-- âœ… ZÃKLADNÃ KONTROLA: Nie sme v samom RpaWinUiComponents projekte -->
  <PropertyGroup>
    <_IsRpaWinUiComponentsProject Condition="'$(AssemblyName)' == 'RpaWinUiComponents' OR '$(MSBuildProjectName)' == 'RpaWinUiComponents'">true</_IsRpaWinUiComponentsProject>
    <_IsRpaWinUiComponentsProject Condition="'$(_IsRpaWinUiComponentsProject)' == ''">false</_IsRpaWinUiComponentsProject>
  </PropertyGroup>

  <!-- âœ… ZÃKLADNÃ‰ NASTAVENIA pre consuming projects -->
  <PropertyGroup Condition="'$(_IsRpaWinUiComponentsProject)' == 'false'">
    <!-- ZabezpeÄenie WinUI 3 nastavenÃ­ -->
    <UseWinUI Condition="'$(UseWinUI)' == ''">true</UseWinUI>

    <!-- âœ… KRITICKÃ OPRAVA: POVOLIÅ¤ XBF sÃºbory pre consuming projects -->
    <!-- XBF sÃºbory sÃº teraz sprÃ¡vne zabalenÃ© v NuGet package -->
    <GenerateXbf Condition="'$(GenerateXbf)' == ''">true</GenerateXbf>
    <EnableXbfGeneration Condition="'$(EnableXbfGeneration)' == ''">true</EnableXbfGeneration>
    <IncludeXbfInPackage>false</IncludeXbfInPackage>

    <!-- ZÃ¡kladnÃ© warning suppression -->
    <NoWarn>$(NoWarn);CS0436;WMC1013;CA1416</NoWarn>

    <!-- MSBuild nastavenia -->
    <ErrorOnDuplicateItems>false</ErrorOnDuplicateItems>
    <TreatWarningsAsErrors>false</TreatWarningsAsErrors>

    <!-- âœ… OPRAVA: MSB3030 ako warning, nie error -->
    <MSBuildWarningsAsMessages>$(MSBuildWarningsAsMessages);MSB3030</MSBuildWarningsAsMessages>
    <MSBuildTreatWarningsAsErrors>false</MSBuildTreatWarningsAsErrors>
  </PropertyGroup>

  <!-- âœ… OPRAVENÃ‰: SprÃ¡vne kopÃ­rovanie XBF sÃºborov z NuGet package -->
  <Target Name="CopyRpaComponentsXbfFiles" BeforeTargets="Build" Condition="'$(_IsRpaWinUiComponentsProject)' == 'false'">

    <Message Text="ðŸ“¦ RpaWinUiComponents v$(RpaWinUiComponentsVersion): Copying XBF files from NuGet package..." Importance="normal" />

    <!-- âœ… NÃ¡jdi XBF sÃºbory v NuGet package -->
    <ItemGroup>
      <RpaXbfFiles Include="@(ReferenceCopyLocalPaths)" Condition="$([System.String]::Copy('%(Identity)').Contains('RpaWinUiComponents')) AND $([System.String]::Copy('%(Identity)').EndsWith('.xbf'))" />
    </ItemGroup>

    <Message Text="âœ… Found RpaWinUiComponents XBF files: @(RpaXbfFiles)" Importance="normal" Condition="'@(RpaXbfFiles)' != ''" />
    <Message Text="âš ï¸ No XBF files found in RpaWinUiComponents package" Importance="normal" Condition="'@(RpaXbfFiles)' == ''" />

    <!-- âœ… ZabezpeÄ Å¾e XBF sÃºbory sa skopÃ­rujÃº do output directory -->
    <ItemGroup Condition="'@(RpaXbfFiles)' != ''">
      <ContentWithTargetPath Include="@(RpaXbfFiles)">
        <TargetPath>%(RecursiveDir)%(Filename)%(Extension)</TargetPath>
        <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      </ContentWithTargetPath>
    </ItemGroup>

  </Target>

  <!-- âœ… ZACHOVANÃ‰: WinUI dependencies -->
  <ItemGroup Condition="'$(UseWinUI)' == 'true' AND '$(_IsRpaWinUiComponentsProject)' == 'false'">
    <PackageReference Include="Microsoft.WindowsAppSDK" Version="1.7.250606001" Condition="'@(PackageReference->WithMetadataValue('Identity', 'Microsoft.WindowsAppSDK'))' == ''" />
    <PackageReference Include="Microsoft.Extensions.DependencyInjection" Version="9.0.6" Condition="'@(PackageReference->WithMetadataValue('Identity', 'Microsoft.Extensions.DependencyInjection'))' == ''" />
    <PackageReference Include="Microsoft.Extensions.Hosting" Version="9.0.6" Condition="'@(PackageReference->WithMetadataValue('Identity', 'Microsoft.Extensions.Hosting'))' == ''" />
    <PackageReference Include="Microsoft.Extensions.Logging.Abstractions" Version="9.0.6" Condition="'@(PackageReference->WithMetadataValue('Identity', 'Microsoft.Extensions.Logging.Abstractions'))' == ''" />
  </ItemGroup>

  <!-- âœ… OPRAVA: Cleanup duplicitnÃ½ch XBF references -->
  <Target Name="CleanupDuplicateXbfReferences" AfterTargets="ResolveAssemblyReferences" Condition="'$(_IsRpaWinUiComponentsProject)' == 'false'">

    <!-- âœ… Identifikuj duplicitnÃ© XBF sÃºbory -->
    <ItemGroup>
      <DuplicateXbfFiles Include="@(ReferenceCopyLocalPaths)" Condition="$([System.String]::Copy('%(ReferenceCopyLocalPaths.Identity)').Contains('RpaWinUiComponents')) AND $([System.String]::Copy('%(ReferenceCopyLocalPaths.Identity)').EndsWith('.xbf'))" />
    </ItemGroup>

    <!-- âœ… OdstrÃ¡Åˆ duplicity ale ponechaj jednu kÃ³piu -->
    <RemoveDuplicates Inputs="@(DuplicateXbfFiles)">
      <Output TaskParameter="Filtered" ItemName="UniqueXbfFiles" />
    </RemoveDuplicates>

    <!-- âœ… Aktualizuj ReferenceCopyLocalPaths -->
    <ItemGroup>
      <ReferenceCopyLocalPaths Remove="@(DuplicateXbfFiles)" />
      <ReferenceCopyLocalPaths Include="@(UniqueXbfFiles)" />
    </ItemGroup>

    <Message Text="ðŸ§¹ Cleaned up duplicate XBF references, kept @(UniqueXbfFiles->Count()) unique files" Importance="normal" />

  </Target>

  <!-- âœ… Info message -->
  <Target Name="RpaWinUiComponentsInfo" BeforeTargets="Build" Condition="'$(_IsRpaWinUiComponentsProject)' == 'false'">
    <Message Text="ðŸ“¦ RpaWinUiComponents v$(RpaWinUiComponentsVersion) (with XBF support)" Importance="normal" />
  </Target>

  <!-- âœ… DIAGNOSTIKA: Pre debugging XBF problÃ©mov -->
  <Target Name="DiagnoseXbfIssues" AfterTargets="ResolvePackageAssets" Condition="'$(_IsRpaWinUiComponentsProject)' == 'false' AND '$(RpaWinUiComponentsDiagnostics)' == 'true'">

    <ItemGroup>
      <RpaXbfFiles Include="@(ReferenceCopyLocalPaths)" Condition="$([System.String]::Copy('%(Identity)').Contains('RpaWinUiComponents')) AND $([System.String]::Copy('%(Identity)').EndsWith('.xbf'))" />
      <RpaXamlFiles Include="@(ReferenceCopyLocalPaths)" Condition="$([System.String]::Copy('%(Identity)').Contains('RpaWinUiComponents')) AND $([System.String]::Copy('%(Identity)').EndsWith('.xaml'))" />
      <RpaDllFiles Include="@(ReferenceCopyLocalPaths)" Condition="$([System.String]::Copy('%(Identity)').Contains('RpaWinUiComponents')) AND $([System.String]::Copy('%(Identity)').EndsWith('.dll'))" />
    </ItemGroup>

    <Message Text="ðŸ” RpaWinUiComponents XBF sÃºbory: @(RpaXbfFiles)" Importance="high" Condition="'@(RpaXbfFiles)' != ''" />
    <Message Text="ðŸ” RpaWinUiComponents XAML sÃºbory: @(RpaXamlFiles)" Importance="high" Condition="'@(RpaXamlFiles)' != ''" />
    <Message Text="ðŸ” RpaWinUiComponents DLL sÃºbory: @(RpaDllFiles)" Importance="high" Condition="'@(RpaDllFiles)' != ''" />
    <Message Text="âš ï¸ Å½iadne XBF sÃºbory nenÃ¡jdenÃ© - skontrolujte NuGet package obsah" Importance="high" Condition="'@(RpaXbfFiles)' == ''" />

    <!-- âœ… Kontrola output directory -->
    <ItemGroup>
      <OutputXbfFiles Include="$(OutputPath)**\*.xbf" />
    </ItemGroup>
    <Message Text="ðŸ” XBF sÃºbory v output directory: @(OutputXbfFiles)" Importance="high" />

  </Target>

  <!-- âœ… FAILSAFE: Ak XBF sÃºbory chÃ½bajÃº, skÃºs ich vytvoriÅ¥ z XAML -->
  <Target Name="EnsureXbfFilesExist" BeforeTargets="Build" Condition="'$(_IsRpaWinUiComponentsProject)' == 'false'">

    <!-- Skontroluj Äi existujÃº kritickÃ© XBF sÃºbory -->
    <ItemGroup>
      <ExpectedXbfFiles Include="$(OutputPath)AdvancedWinUiDataGrid\Views\EnhancedDataGridControl.xbf" />
      <ExpectedXbfFiles Include="$(OutputPath)AdvancedWinUiDataGrid\Themes\Generic.xbf" />
    </ItemGroup>

    <ItemGroup>
      <MissingXbfFiles Include="@(ExpectedXbfFiles)" Condition="!Exists('%(Identity)')" />
    </ItemGroup>

    <Warning Text="âš ï¸ Missing XBF files: @(MissingXbfFiles). Trying to regenerate from XAML..." Condition="'@(MissingXbfFiles)' != ''" />

  </Target>

</Project>