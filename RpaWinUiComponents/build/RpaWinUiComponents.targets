<?xml version="1.0" encoding="utf-8"?>
<!-- build/RpaWinUiComponents.targets - OPRAVA CIEST K DLL -->
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <RpaWinUiComponentsVersion Condition="'$(RpaWinUiComponentsVersion)' == ''">1.0.8</RpaWinUiComponentsVersion>
  </PropertyGroup>

  <!-- ✅ KRITICKÁ OPRAVA: Kontrola či nie sme v projekte RpaWinUiComponents samom -->
  <PropertyGroup>
    <_IsRpaWinUiComponentsProject Condition="'$(AssemblyName)' == 'RpaWinUiComponents' OR '$(MSBuildProjectName)' == 'RpaWinUiComponents'">true</_IsRpaWinUiComponentsProject>
    <_IsRpaWinUiComponentsProject Condition="'$(_IsRpaWinUiComponentsProject)' == ''">false</_IsRpaWinUiComponentsProject>
  </PropertyGroup>

  <!-- ✅ OPRAVENÉ: Detect target framework -->
  <PropertyGroup>
    <_RpaWinUiTargetFramework Condition="'$(TargetFramework)' != ''">$(TargetFramework)</_RpaWinUiTargetFramework>
    <_RpaWinUiTargetFramework Condition="'$(_RpaWinUiTargetFramework)' == ''">net8.0-windows10.0.19041.0</_RpaWinUiTargetFramework>
  </PropertyGroup>

  <!-- ✅ OPRAVENÉ: Správne cesty k DLL súboru -->
  <PropertyGroup>
    <!-- NAJPRV skúsime najšpecifickejšiu cestu -->
    <_RpaWinUiComponentsLibPath1>$(MSBuildThisFileDirectory)../lib/$(_RpaWinUiTargetFramework)/RpaWinUiComponents.dll</_RpaWinUiComponentsLibPath1>
    
    <!-- Fallback cesty pre rôzne framework verzie -->
    <_RpaWinUiComponentsLibPath2>$(MSBuildThisFileDirectory)../lib/net8.0-windows10.0.19041.0/RpaWinUiComponents.dll</_RpaWinUiComponentsLibPath2>
    <_RpaWinUiComponentsLibPath3>$(MSBuildThisFileDirectory)../lib/net8.0-windows/RpaWinUiComponents.dll</_RpaWinUiComponentsLibPath3>
    <_RpaWinUiComponentsLibPath4>$(MSBuildThisFileDirectory)../lib/net8.0/RpaWinUiComponents.dll</_RpaWinUiComponentsLibPath4>
    
    <!-- Pre prípad že je DLL v root -->
    <_RpaWinUiComponentsLibPath5>$(MSBuildThisFileDirectory)../RpaWinUiComponents.dll</_RpaWinUiComponentsLibPath5>
    
    <!-- Pre prípad že je v bin adresári -->
    <_RpaWinUiComponentsLibPath6>$(MSBuildThisFileDirectory)../bin/RpaWinUiComponents.dll</_RpaWinUiComponentsLibPath6>
  </PropertyGroup>

  <!-- ✅ Ensure WinUI 3 dependencies for consuming projects -->
  <ItemGroup Condition="'$(UseWinUI)' == 'true' OR '$(TargetFramework)' == 'net8.0-windows10.0.19041.0'">
    <PackageReference Include="Microsoft.WindowsAppSDK" Version="1.7.250606001" Condition="'@(PackageReference->WithMetadataValue('Identity', 'Microsoft.WindowsAppSDK'))' == ''" />
    <PackageReference Include="Microsoft.Extensions.DependencyInjection" Version="9.0.6" Condition="'@(PackageReference->WithMetadataValue('Identity', 'Microsoft.Extensions.DependencyInjection'))' == ''" />
    <PackageReference Include="Microsoft.Extensions.Hosting" Version="9.0.6" Condition="'@(PackageReference->WithMetadataValue('Identity', 'Microsoft.Extensions.Hosting'))' == ''" />
    <PackageReference Include="Microsoft.Extensions.Logging.Abstractions" Version="9.0.6" Condition="'@(PackageReference->WithMetadataValue('Identity', 'Microsoft.Extensions.Logging.Abstractions'))' == ''" />
  </ItemGroup>

  <!-- ✅ Force UseWinUI if not set and we're targeting Windows -->
  <PropertyGroup Condition="'$(UseWinUI)' == '' AND ('$(TargetFramework)' == 'net8.0-windows10.0.19041.0' OR $(TargetFramework.Contains('windows')))">
    <UseWinUI>true</UseWinUI>
  </PropertyGroup>

  <!-- ✅ KĽÚČOVÁ OPRAVA: Pokus nájsť DLL v rôznych lokáciách -->
  <Target Name="FindRpaWinUiComponentsLibrary" BeforeTargets="ResolveAssemblyReferences" Condition="'$(_IsRpaWinUiComponentsProject)' == 'false'">
    
    <!-- Nájdi existujúcu DLL -->
    <PropertyGroup>
      <_LibraryPath></_LibraryPath>
      <_LibraryPath Condition="'$(_LibraryPath)' == '' AND Exists('$(_RpaWinUiComponentsLibPath1)')">$(_RpaWinUiComponentsLibPath1)</_LibraryPath>
      <_LibraryPath Condition="'$(_LibraryPath)' == '' AND Exists('$(_RpaWinUiComponentsLibPath2)')">$(_RpaWinUiComponentsLibPath2)</_LibraryPath>
      <_LibraryPath Condition="'$(_LibraryPath)' == '' AND Exists('$(_RpaWinUiComponentsLibPath3)')">$(_RpaWinUiComponentsLibPath3)</_LibraryPath>
      <_LibraryPath Condition="'$(_LibraryPath)' == '' AND Exists('$(_RpaWinUiComponentsLibPath4)')">$(_RpaWinUiComponentsLibPath4)</_LibraryPath>
      <_LibraryPath Condition="'$(_LibraryPath)' == '' AND Exists('$(_RpaWinUiComponentsLibPath5)')">$(_RpaWinUiComponentsLibPath5)</_LibraryPath>
      <_LibraryPath Condition="'$(_LibraryPath)' == '' AND Exists('$(_RpaWinUiComponentsLibPath6)')">$(_RpaWinUiComponentsLibPath6)</_LibraryPath>
    </PropertyGroup>

    <!-- Debug output všetkých ciest -->
    <Message Text="🔍 Searching for RpaWinUiComponents.dll in:" Importance="low" />
    <Message Text="  Path 1: $(_RpaWinUiComponentsLibPath1) [Exists: $(Exists('$(_RpaWinUiComponentsLibPath1)'))]" Importance="low" />
    <Message Text="  Path 2: $(_RpaWinUiComponentsLibPath2) [Exists: $(Exists('$(_RpaWinUiComponentsLibPath2)'))]" Importance="low" />
    <Message Text="  Path 3: $(_RpaWinUiComponentsLibPath3) [Exists: $(Exists('$(_RpaWinUiComponentsLibPath3)'))]" Importance="low" />
    <Message Text="  Path 4: $(_RpaWinUiComponentsLibPath4) [Exists: $(Exists('$(_RpaWinUiComponentsLibPath4)'))]" Importance="low" />
    <Message Text="  Path 5: $(_RpaWinUiComponentsLibPath5) [Exists: $(Exists('$(_RpaWinUiComponentsLibPath5)'))]" Importance="low" />
    <Message Text="  Path 6: $(_RpaWinUiComponentsLibPath6) [Exists: $(Exists('$(_RpaWinUiComponentsLibPath6)'))]" Importance="low" />

    <!-- Ak sa našla DLL, pridaj reference -->
    <ItemGroup Condition="'$(_LibraryPath)' != ''">
      <Reference Include="RpaWinUiComponents">
        <HintPath>$(_LibraryPath)</HintPath>
        <Private>False</Private>
        <SpecificVersion>False</SpecificVersion>
      </Reference>
    </ItemGroup>

    <!-- Success/Error messages -->
    <Message Text="✅ RpaWinUiComponents: Found library at $(_LibraryPath)" Importance="normal" Condition="'$(_LibraryPath)' != ''" />
    
    <!-- OPRAVA: Warning len ak sa skutočne nenašla DLL -->
    <Warning Text="❌ RpaWinUiComponents: Library not found in any expected location. Please verify NuGet package installation." Condition="'$(_LibraryPath)' == '' AND '$(Configuration)' != 'Debug'" />
    <Message Text="⚠️ RpaWinUiComponents: Library not found, but this is normal during development. Package directory: $(MSBuildThisFileDirectory)" Importance="low" Condition="'$(_LibraryPath)' == '' AND '$(Configuration)' == 'Debug'" />
  </Target>

  <!-- ✅ Info message - LEN AK NIE SME V SAMOM PROJEKTE -->
  <Target Name="RpaWinUiComponentsInfo" BeforeTargets="Build" Condition="'$(_IsRpaWinUiComponentsProject)' == 'false'">
    <Message Text="📦 RpaWinUiComponents v$(RpaWinUiComponentsVersion) for $(_RpaWinUiTargetFramework)" Importance="low" />
    <Message Text="🔧 UseWinUI: $(UseWinUI), TargetFramework: $(TargetFramework)" Importance="low" />
  </Target>

  <!-- ✅ Ensure proper configuration for WinUI projects -->
  <Target Name="ConfigureWinUIProperties" BeforeTargets="PrepareForBuild" Condition="'$(UseWinUI)' == 'true'">
    <PropertyGroup>
      <!-- Set default values if not already set -->
      <WindowsPackageType Condition="'$(WindowsPackageType)' == ''">None</WindowsPackageType>
      <WindowsAppSDKSelfContained Condition="'$(WindowsAppSDKSelfContained)' == ''">false</WindowsAppSDKSelfContained>
      <EnableMsixTooling Condition="'$(EnableMsixTooling)' == ''">false</EnableMsixTooling>
    </PropertyGroup>
  </Target>

  <!-- ✅ Suppress common warnings in consuming projects -->
  <PropertyGroup>
    <NoWarn>$(NoWarn);CS0436;CS1061;CS1537;CS1503;CS0104;CS0234;WMC1013</NoWarn>
  </PropertyGroup>

</Project>