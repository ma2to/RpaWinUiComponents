<?xml version="1.0" encoding="utf-8"?>
<!-- build/RpaWinUiComponents.targets - OPRAVENÉ XBF handling v1.0.20 -->
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <RpaWinUiComponentsVersion Condition="'$(RpaWinUiComponentsVersion)' == ''">1.0.20</RpaWinUiComponentsVersion>
  </PropertyGroup>

  <!-- ✅ ZÁKLADNÁ KONTROLA: Nie sme v samom RpaWinUiComponents projekte -->
  <PropertyGroup>
    <_IsRpaWinUiComponentsProject Condition="'$(AssemblyName)' == 'RpaWinUiComponents' OR '$(MSBuildProjectName)' == 'RpaWinUiComponents'">true</_IsRpaWinUiComponentsProject>
    <_IsRpaWinUiComponentsProject Condition="'$(_IsRpaWinUiComponentsProject)' == ''">false</_IsRpaWinUiComponentsProject>
  </PropertyGroup>

  <!-- ✅ ZÁKLADNÉ NASTAVENIA pre consuming projects -->
  <PropertyGroup Condition="'$(_IsRpaWinUiComponentsProject)' == 'false'">
    <!-- Zabezpečenie WinUI 3 nastavení -->
    <UseWinUI Condition="'$(UseWinUI)' == ''">true</UseWinUI>

    <!-- ✅ KRITICKÁ OPRAVA: Zakázanie XBF súborov pre consuming projects -->
    <!-- XBF súbory spôsobujú MSB3030 chyby v NuGet package consumer projektoch -->
    <GenerateXbf>false</GenerateXbf>
    <EnableXbfGeneration>false</EnableXbfGeneration>
    <IncludeXbfInPackage>false</IncludeXbfInPackage>

    <!-- Základné warning suppression -->
    <NoWarn>$(NoWarn);CS0436;WMC1013;CA1416;MSB3030</NoWarn>

    <!-- MSBuild nastavenia -->
    <ErrorOnDuplicateItems>false</ErrorOnDuplicateItems>
    <TreatWarningsAsErrors>false</TreatWarningsAsErrors>

    <!-- ✅ OPRAVA: MSB3030 ako warning, nie error -->
    <MSBuildWarningsAsMessages>$(MSBuildWarningsAsMessages);MSB3030</MSBuildWarningsAsMessages>
    <MSBuildTreatWarningsAsErrors>false</MSBuildTreatWarningsAsErrors>
  </PropertyGroup>

  <!-- ✅ OPRAVA: Disable XBF dependency pre RpaWinUiComponents -->
  <Target Name="DisableXbfForRpaComponents" BeforeTargets="ResolveAssemblyReferences" Condition="'$(_IsRpaWinUiComponentsProject)' == 'false'">

    <PropertyGroup>
      <!-- Force disable XBF processing pre RpaWinUiComponents XAML súbory -->
      <DisableXbfLineInfo>true</DisableXbfLineInfo>
      <XbfGenerationDisabled>true</XbfGenerationDisabled>
    </PropertyGroup>

    <Message Text="✅ RpaWinUiComponents v$(RpaWinUiComponentsVersion): XBF zakázané pre consuming project" Importance="normal" />

    <!-- ✅ Remove XBF files from reference if they exist -->
    <ItemGroup>
      <Reference Remove="**\RpaWinUiComponents\**\*.xbf" />
      <ReferenceCopyLocalPaths Remove="**\RpaWinUiComponents\**\*.xbf" />
      <Content Remove="**\RpaWinUiComponents\**\*.xbf" />
    </ItemGroup>

  </Target>

  <!-- ✅ ZACHOVANÉ: WinUI dependencies -->
  <ItemGroup Condition="'$(UseWinUI)' == 'true' AND '$(_IsRpaWinUiComponentsProject)' == 'false'">
    <PackageReference Include="Microsoft.WindowsAppSDK" Version="1.7.250606001" Condition="'@(PackageReference->WithMetadataValue('Identity', 'Microsoft.WindowsAppSDK'))' == ''" />
    <PackageReference Include="Microsoft.Extensions.DependencyInjection" Version="9.0.6" Condition="'@(PackageReference->WithMetadataValue('Identity', 'Microsoft.Extensions.DependencyInjection'))' == ''" />
    <PackageReference Include="Microsoft.Extensions.Hosting" Version="9.0.6" Condition="'@(PackageReference->WithMetadataValue('Identity', 'Microsoft.Extensions.Hosting'))' == ''" />
    <PackageReference Include="Microsoft.Extensions.Logging.Abstractions" Version="9.0.6" Condition="'@(PackageReference->WithMetadataValue('Identity', 'Microsoft.Extensions.Logging.Abstractions'))' == ''" />
  </ItemGroup>

  <!-- ✅ OPRAVA: Clean up XBF references that cause MSB3030 -->
  <Target Name="CleanupXbfReferences" AfterTargets="ResolveAssemblyReferences" Condition="'$(_IsRpaWinUiComponentsProject)' == 'false'">

    <!-- Remove problematic XBF file references -->
    <ItemGroup>
      <ReferenceCopyLocalPaths Remove="@(ReferenceCopyLocalPaths)" Condition="$([System.String]::Copy('%(ReferenceCopyLocalPaths.Identity)').Contains('RpaWinUiComponents')) AND $([System.String]::Copy('%(ReferenceCopyLocalPaths.Identity)').EndsWith('.xbf'))" />
      <ContentWithTargetPath Remove="@(ContentWithTargetPath)" Condition="$([System.String]::Copy('%(ContentWithTargetPath.Identity)').Contains('RpaWinUiComponents')) AND $([System.String]::Copy('%(ContentWithTargetPath.Identity)').EndsWith('.xbf'))" />
    </ItemGroup>

    <Message Text="🧹 Cleaned up XBF references to prevent MSB3030 errors" Importance="normal" />

  </Target>

  <!-- ✅ Info message -->
  <Target Name="RpaWinUiComponentsInfo" BeforeTargets="Build" Condition="'$(_IsRpaWinUiComponentsProject)' == 'false'">
    <Message Text="📦 RpaWinUiComponents v$(RpaWinUiComponentsVersion) (bez XBF - XAML only)" Importance="normal" />
  </Target>

  <!-- ✅ DIAGNOSTIKA: Pre debugging XBF problémov -->
  <Target Name="DiagnoseXbfIssues" AfterTargets="ResolvePackageAssets" Condition="'$(_IsRpaWinUiComponentsProject)' == 'false' AND '$(RpaWinUiComponentsDiagnostics)' == 'true'">

    <ItemGroup>
      <RpaXbfFiles Include="@(ReferenceCopyLocalPaths)" Condition="$([System.String]::Copy('%(Identity)').Contains('RpaWinUiComponents')) AND $([System.String]::Copy('%(Identity)').EndsWith('.xbf'))" />
      <RpaXamlFiles Include="@(ReferenceCopyLocalPaths)" Condition="$([System.String]::Copy('%(Identity)').Contains('RpaWinUiComponents')) AND $([System.String]::Copy('%(Identity)').EndsWith('.xaml'))" />
    </ItemGroup>

    <Message Text="🔍 RpaWinUiComponents XBF súbory: @(RpaXbfFiles)" Importance="high" Condition="'@(RpaXbfFiles)' != ''" />
    <Message Text="🔍 RpaWinUiComponents XAML súbory: @(RpaXamlFiles)" Importance="high" Condition="'@(RpaXamlFiles)' != ''" />
    <Message Text="✅ Žiadne XBF súbory - používajú sa len XAML súbory" Importance="high" Condition="'@(RpaXbfFiles)' == ''" />

  </Target>

</Project>