<?xml version="1.0" encoding="utf-8"?>
<!-- build/RpaWinUiComponents.targets - OPRAVENÃ pre flexibilnÃ© DLL vyhÄ¾adÃ¡vanie -->
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <RpaWinUiComponentsVersion Condition="'$(RpaWinUiComponentsVersion)' == ''">1.0.6</RpaWinUiComponentsVersion>
    <UseWinUI Condition="'$(UseWinUI)' == ''">true</UseWinUI>
  </PropertyGroup>

  <!-- âœ… Ensure WinUI 3 is properly configured -->
  <ItemGroup Condition="'$(UseWinUI)' == 'true'">
    <PackageReference Include="Microsoft.WindowsAppSDK" Version="1.7.250606001" Condition="'@(PackageReference->WithMetadataValue('Identity', 'Microsoft.WindowsAppSDK'))' == ''" />
    <PackageReference Include="Microsoft.Extensions.DependencyInjection" Version="9.0.6" Condition="'@(PackageReference->WithMetadataValue('Identity', 'Microsoft.Extensions.DependencyInjection'))' == ''" />
    <PackageReference Include="Microsoft.Extensions.Hosting" Version="9.0.6" Condition="'@(PackageReference->WithMetadataValue('Identity', 'Microsoft.Extensions.Hosting'))' == ''" />
  </ItemGroup>

  <!-- âœ… KRITICKÃ‰: FlexibilnÃ© DLL reference -->
  <Target Name="EnsureRpaWinUiComponentsReferences" BeforeTargets="ResolveAssemblyReferences">
    <PropertyGroup>
      <!-- SkÃºÅ¡ame rÃ´zne moÅ¾nÃ© lokÃ¡cie DLL -->
      <_RpaWinUiComponentsPath Condition="Exists('$(MSBuildThisFileDirectory)../lib/$(TargetFramework)/RpaWinUiComponents.dll')">$(MSBuildThisFileDirectory)../lib/$(TargetFramework)/RpaWinUiComponents.dll</_RpaWinUiComponentsPath>
      <_RpaWinUiComponentsPath Condition="'$(_RpaWinUiComponentsPath)' == '' AND Exists('$(MSBuildThisFileDirectory)../lib/net8.0-windows10.0.19041.0/RpaWinUiComponents.dll')">$(MSBuildThisFileDirectory)../lib/net8.0-windows10.0.19041.0/RpaWinUiComponents.dll</_RpaWinUiComponentsPath>
      <_RpaWinUiComponentsPath Condition="'$(_RpaWinUiComponentsPath)' == '' AND Exists('$(MSBuildThisFileDirectory)../lib/net8.0-windows/RpaWinUiComponents.dll')">$(MSBuildThisFileDirectory)../lib/net8.0-windows/RpaWinUiComponents.dll</_RpaWinUiComponentsPath>
      <_RpaWinUiComponentsPath Condition="'$(_RpaWinUiComponentsPath)' == '' AND Exists('$(MSBuildThisFileDirectory)../lib/RpaWinUiComponents.dll')">$(MSBuildThisFileDirectory)../lib/RpaWinUiComponents.dll</_RpaWinUiComponentsPath>
    </PropertyGroup>

    <ItemGroup Condition="'$(_RpaWinUiComponentsPath)' != ''">
      <Reference Include="$(_RpaWinUiComponentsPath)" />
    </ItemGroup>

    <!-- DiagnostickÃ© sprÃ¡vy -->
    <Message Text="âœ… RpaWinUiComponents DLL found at: $(_RpaWinUiComponentsPath)" Importance="normal" Condition="'$(_RpaWinUiComponentsPath)' != ''" />

    <!-- Ak DLL nie je nÃ¡jdenÃ¡, vypÃ­Å¡eme diagnostiku -->
    <ItemGroup Condition="'$(_RpaWinUiComponentsPath)' == ''">
      <_CheckedPaths Include="$(MSBuildThisFileDirectory)../lib/$(TargetFramework)/RpaWinUiComponents.dll" />
      <_CheckedPaths Include="$(MSBuildThisFileDirectory)../lib/net8.0-windows10.0.19041.0/RpaWinUiComponents.dll" />
      <_CheckedPaths Include="$(MSBuildThisFileDirectory)../lib/net8.0-windows/RpaWinUiComponents.dll" />
      <_CheckedPaths Include="$(MSBuildThisFileDirectory)../lib/RpaWinUiComponents.dll" />
    </ItemGroup>

    <Message Text="âš ï¸ RpaWinUiComponents DLL not found. Checked locations:" Importance="high" Condition="'$(_RpaWinUiComponentsPath)' == ''" />
    <Message Text="   - %(_CheckedPaths.Identity)" Importance="high" Condition="'$(_RpaWinUiComponentsPath)' == ''" />
  </Target>

  <!-- âœ… Diagnostika package Å¡truktÃºry -->
  <Target Name="DiagnosePackageStructure" BeforeTargets="EnsureRpaWinUiComponentsReferences" Condition="'$(_RpaWinUiComponentsPath)' == ''">
    <Message Text="ðŸ” RPA Package Structure Diagnostics:" Importance="high" />
    <Message Text="   Package path: $(MSBuildThisFileDirectory)../" Importance="high" />
    <Message Text="   Target framework: $(TargetFramework)" Importance="high" />

    <!-- VypÃ­Å¡eme vÅ¡etky sÃºbory v package -->
    <ItemGroup>
      <AllPackageFiles Include="$(MSBuildThisFileDirectory)../**/*.*" />
    </ItemGroup>

    <Message Text="ðŸ“ All package files:" Importance="high" />
    <Message Text="   %(AllPackageFiles.Identity)" Importance="normal" />

    <!-- HÄ¾adÃ¡me DLL sÃºbory -->
    <ItemGroup>
      <AllDllFiles Include="$(MSBuildThisFileDirectory)../**/*.dll" />
    </ItemGroup>

    <Message Text="ðŸ” DLL files found in package:" Importance="high" />
    <Message Text="   %(AllDllFiles.Identity)" Importance="high" />
  </Target>

  <!-- âœ… KopÃ­rovanie XBF sÃºborov (ak existujÃº) -->
  <Target Name="CopyRpaWinUiComponentsXbfFiles" BeforeTargets="Build" AfterTargets="ResolvePackageAssets">
    <PropertyGroup>
      <RpaPackagePath>$(MSBuildThisFileDirectory)../lib/$(TargetFramework)/</RpaPackagePath>
      <RpaContentPath>$(RpaPackagePath)RpaWinUiComponents/</RpaContentPath>
      <RpaTargetPath>$(OutputPath)RpaWinUiComponents/</RpaTargetPath>
    </PropertyGroup>

    <!-- Skontrolovanie Äi existujÃº XBF sÃºbory -->
    <ItemGroup Condition="Exists('$(RpaContentPath)')">
      <RpaXbfFiles Include="$(RpaContentPath)**/*.xbf" />
      <RpaXamlFiles Include="$(RpaContentPath)**/*.xaml" />
      <RpaPriFiles Include="$(RpaPackagePath)*.pri" />
      <RpaXrXmlFiles Include="$(RpaContentPath)**/*.xr.xml" />
    </ItemGroup>

    <!-- KopÃ­rovanie sÃºborov ak existujÃº -->
    <MakeDir Directories="$(RpaTargetPath)AdvancedWinUiDataGrid\Views\" Condition="'@(RpaXbfFiles)' != ''" />
    <MakeDir Directories="$(RpaTargetPath)AdvancedWinUiDataGrid\Themes\" Condition="'@(RpaXbfFiles)' != ''" />

    <Copy SourceFiles="@(RpaXbfFiles)"
          DestinationFolder="$(RpaTargetPath)%(RecursiveDir)"
          SkipUnchangedFiles="true"
          Condition="'@(RpaXbfFiles)' != ''" />

    <Copy SourceFiles="@(RpaXamlFiles)"
          DestinationFolder="$(RpaTargetPath)%(RecursiveDir)"
          SkipUnchangedFiles="true"
          Condition="'@(RpaXamlFiles)' != ''" />

    <Copy SourceFiles="@(RpaPriFiles)"
          DestinationFolder="$(OutputPath)"
          SkipUnchangedFiles="true"
          Condition="'@(RpaPriFiles)' != ''" />

    <Copy SourceFiles="@(RpaXrXmlFiles)"
          DestinationFolder="$(RpaTargetPath)"
          SkipUnchangedFiles="true"
          Condition="'@(RpaXrXmlFiles)' != ''" />

    <!-- Status sprÃ¡vy -->
    <Message Text="âœ… Copied @(RpaXbfFiles->Count()) XBF files" Importance="normal" Condition="'@(RpaXbfFiles)' != ''" />
    <Message Text="âœ… Copied @(RpaPriFiles->Count()) PRI files" Importance="normal" Condition="'@(RpaPriFiles)' != ''" />
    <Message Text="â„¹ï¸ No XBF files found in package" Importance="low" Condition="'@(RpaXbfFiles)' == ''" />
  </Target>

</Project>